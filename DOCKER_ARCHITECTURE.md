# ResearchNexus Docker 架构设计文档

## 📐 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     用户浏览器                               │
│              (Chrome, Firefox, Safari 等)                   │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTP/HTTPS
┌────────────────────────▼────────────────────────────────────┐
│                  Docker 容器编排层                           │
│                 (Docker Compose)                            │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────┐      ┌──────────────────────┐    │
│  │   Nginx 容器         │      │  ResearchNexus 容器  │    │
│  │  (可选)              │      │  (Node.js + Serve)   │    │
│  │                      │      │                      │    │
│  │ - SSL/TLS 终止       │◄────►│ - 静态文件服务       │    │
│  │ - 反向代理           │      │ - 端口 3000          │    │
│  │ - 缓存               │      │ - 健康检查           │    │
│  │ - 安全头             │      │                      │    │
│  │ - 端口 80/443        │      │                      │    │
│  └──────────────────────┘      └──────────────────────┘    │
│                                                              │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTPS
┌────────────────────────▼────────────────────────────────────┐
│                   外部服务                                   │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────┐      ┌──────────────────────┐    │
│  │   Supabase           │      │  Google Gemini API   │    │
│  │  (PostgreSQL)        │      │  (AI 摘要)           │    │
│  │                      │      │                      │    │
│  │ - 数据库             │      │ - 文本生成           │    │
│  │ - 认证               │      │ - 内容分析           │    │
│  │ - 存储               │      │                      │    │
│  └──────────────────────┘      └──────────────────────┘    │
│                                                              │
└────────────────────────────────────────────────────────────┘
```

## 🐳 Docker 镜像结构

### 多阶段构建

```
构建阶段 (Builder)
├── 基础镜像: node:20-alpine
├── 工作目录: /app
├── 安装依赖: npm ci
├── 复制源代码
├── 构建应用: npm run build
└── 输出: dist/ 目录

        ↓ (仅复制 dist/)

运行阶段 (Runtime)
├── 基础镜像: node:20-alpine
├── 工作目录: /app
├── 安装 serve: npm install -g serve
├── 复制构建输出: dist/
├── 暴露端口: 3000
├── 健康检查
└── 启动命令: serve -s dist -l 3000
```

### 镜像优化

| 阶段 | 大小 | 说明 |
|------|------|------|
| 构建阶段 | ~800MB | 包含所有开发依赖 |
| 运行阶段 | ~200MB | 仅包含生产依赖 |
| 最终镜像 | ~200MB | 轻量级生产镜像 |

## 🔄 容器生命周期

### 启动流程

```
1. docker-compose up -d
   ↓
2. 构建镜像 (如果不存在)
   ├── 执行构建阶段
   ├── 执行运行阶段
   └── 生成镜像
   ↓
3. 创建容器
   ├── 分配资源
   ├── 挂载卷
   └── 配置网络
   ↓
4. 启动容器
   ├── 执行启动命令
   ├── 运行健康检查
   └── 容器就绪
```

### 停止流程

```
1. docker-compose down
   ↓
2. 停止容器
   ├── 发送 SIGTERM 信号
   ├── 等待优雅关闭 (10s)
   └── 强制关闭 (SIGKILL)
   ↓
3. 删除容器
   ├── 移除网络
   ├── 释放资源
   └── 清理卷 (可选)
```

## 🌐 网络架构

### 容器网络

```
Docker 网络: researchnexus-network (bridge)

┌─────────────────────────────────────────┐
│  researchnexus-network (bridge)         │
│                                         │
│  ┌──────────────┐    ┌──────────────┐  │
│  │ nginx        │    │ app          │  │
│  │ 172.20.0.2   │◄──►│ 172.20.0.3   │  │
│  │ :80, :443    │    │ :3000        │  │
│  └──────────────┘    └──────────────┘  │
│                                         │
└─────────────────────────────────────────┘
         ↓ (NAT)
    主机网络
    localhost:80
    localhost:443
```

### DNS 解析

- 容器内部：`app:3000` → 172.20.0.3:3000
- 容器内部：`nginx:80` → 172.20.0.2:80
- 主机访问：`localhost:3000` → 127.0.0.1:3000

## 💾 存储架构

### 卷挂载

```
开发环境:
├── 源代码: ./ → /app (读写)
├── node_modules: /app/node_modules (匿名卷)
└── 日志: 容器内存储

生产环境:
├── 构建输出: ./dist → /app/dist (只读)
├── Nginx 配置: ./nginx.conf → /etc/nginx/nginx.conf (只读)
├── SSL 证书: ./certs → /etc/nginx/certs (只读)
└── 缓存: nginx-cache (命名卷)
```

### 数据持久化

```
应用数据:
├── 项目数据: Supabase (外部)
├── 文件存储: Supabase Storage (外部)
└── 用户主题: Supabase (外部)

容器日志:
├── 驱动: json-file
├── 位置: /var/lib/docker/containers/
├── 最大大小: 10MB
└── 最大文件数: 3
```

## 🔐 安全架构

### 隔离层次

```
┌─────────────────────────────────────────┐
│  主机操作系统                            │
├─────────────────────────────────────────┤
│  Docker 守护进程                         │
├─────────────────────────────────────────┤
│  容器隔离 (namespace + cgroup)           │
├─────────────────────────────────────────┤
│  应用进程                                │
└─────────────────────────────────────────┘
```

### 安全特性

| 特性 | 说明 |
|------|------|
| 网络隔离 | 容器网络与主机隔离 |
| 资源限制 | CPU 和内存限制 |
| 只读文件系统 | 生产环境使用只读挂载 |
| 非 root 用户 | 容器以非 root 用户运行 |
| 环境变量隔离 | 敏感信息不在镜像中 |

## 📊 资源管理

### 资源限制配置

```yaml
开发环境:
  CPU: 1 核 (限制) / 0.5 核 (预留)
  内存: 512MB (限制) / 256MB (预留)

生产环境:
  CPU: 0.5 核 (限制) / 0.25 核 (预留)
  内存: 256MB (限制) / 128MB (预留)
```

### 资源监控

```bash
# 实时监控
docker stats researchnexus-app

# 查看历史数据
docker inspect researchnexus-app | grep -A 20 Memory
```

## 🔍 健康检查

### 检查机制

```
间隔: 30 秒
超时: 3 秒
重试: 3 次
启动期: 5 秒

检查命令:
wget --quiet --tries=1 --spider http://localhost:3000/

状态:
├── healthy: 检查通过
├── unhealthy: 检查失败
└── starting: 启动期间
```

### 故障恢复

```
1. 检查失败 3 次
   ↓
2. 容器标记为 unhealthy
   ↓
3. 根据重启策略处理
   ├── unless-stopped: 自动重启
   ├── always: 自动重启
   └── on-failure: 条件重启
```

## 📈 扩展性

### 水平扩展

```bash
# 运行多个应用实例
docker-compose up -d --scale app=3

# Nginx 负载均衡
upstream app {
    server app:3000;
    server app:3001;
    server app:3002;
}
```

### 垂直扩展

```yaml
# 增加资源限制
deploy:
  resources:
    limits:
      cpus: '2'
      memory: 1G
```

## 🚀 部署策略

### 蓝绿部署

```
1. 启动新版本容器 (绿)
2. 运行健康检查
3. 切换 Nginx 流量
4. 保留旧版本容器 (蓝) 用于回滚
5. 验证后删除旧版本
```

### 滚动更新

```
1. 停止一个容器
2. 启动新版本容器
3. 等待健康检查通过
4. 重复步骤 1-3
```

## 📚 相关文件

- `Dockerfile` - 镜像定义
- `docker-compose.yml` - 开发环境配置
- `docker-compose.prod.yml` - 生产环境配置
- `nginx.conf` - Nginx 配置
- `.dockerignore` - 构建上下文忽略
- `Makefile` - 命令简化
- `scripts/deploy.sh` - 部署脚本

